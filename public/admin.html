<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>SALEA Management Admin</title>
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #0f172a;
      color: #e5e7eb;
      margin: 0;
      padding: 0;
    }
    header {
      background: #020617;
      padding: 12px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid #1f2937;
    }
    .logo {
      font-weight: 700;
      font-size: 18px;
    }
    .container {
      padding: 16px 24px;
      display: grid;
      grid-template-columns: 260px 1fr 300px;
      gap: 16px;
    }
    .card {
      background: #020617;
      border-radius: 12px;
      padding: 12px 14px;
      border: 1px solid #1f2937;
      margin-bottom: 10px;
    }
    h2, h3 {
      margin-top: 0;
      font-size: 16px;
      color: #f9fafb;
    }
    label {
      font-size: 13px;
      color: #9ca3af;
      display: block;
      margin-bottom: 4px;
    }
    select, textarea, input {
      width: 100%;
      background: #020617;
      border-radius: 6px;
      border: 1px solid #374151;
      color: #e5e7eb;
      padding: 6px 8px;
      font-size: 13px;
      margin-bottom: 8px;
    }
    button {
      background: #2563eb;
      color: white;
      border: none;
      border-radius: 6px;
      padding: 6px 10px;
      font-size: 13px;
      cursor: pointer;
    }
    button.secondary {
      background: #4b5563;
    }
    button.danger {
      background: #b91c1c;
    }
    button:disabled {
      opacity: 0.5;
      cursor: default;
    }
    pre {
      background: #020617;
      border-radius: 8px;
      padding: 8px;
      font-size: 12px;
      overflow-x: auto;
    }
    .pill {
      display: inline-block;
      padding: 2px 6px;
      border-radius: 999px;
      font-size: 11px;
      margin-right: 4px;
      margin-bottom: 2px;
    }
    .pill.open { background: #064e3b; color: #bbf7d0; }
    .pill.closed { background: #4b5563; color: #e5e7eb; }
    .pill.pending { background: #78350f; color: #fed7aa; }
    .pill.approved { background: #14532d; color: #bbf7d0; }
    .pill.denied { background: #7f1d1d; color: #fecaca; }
    .list {
      max-height: 260px;
      overflow-y: auto;
      font-size: 13px;
    }
    .row {
      border-bottom: 1px solid #1f2937;
      padding: 4px 0;
    }
    .row:hover {
      background: #020617;
    }
    .small {
      font-size: 12px;
      color: #9ca3af;
    }
    .tag {
      font-size: 11px;
      color: #9ca3af;
    }
    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
    }
    .stack {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
    }
  </style>
</head>
<body>
<header>
  <div class="logo">SALEA Management Admin</div>
  <div id="user-info" class="small">Loading...</div>
</header>

<div class="container">
  <!-- Left column: guild + config + panel deploy -->
  <div>
    <div class="card">
      <h2>1. Guild</h2>
      <label for="guild-select">Select guild</label>
      <select id="guild-select"></select>
      <button id="reload-guild">Reload</button>
    </div>

    <div class="card">
      <div class="section-header">
        <h3>2. Guild Config (raw)</h3>
        <button id="save-config" class="secondary">Save</button>
      </div>
      <textarea id="config-json" rows="16" spellcheck="false"></textarea>
      <div class="small">
        Edit JSON to manage:
        <ul>
          <li><code>adminRoleIds</code> – roles that can use bot admin commands</li>
          <li><code>clockTypes</code> – keys, labels, and on-duty role behavior</li>
          <li><code>onDutyRoleId</code>, <code>clockStatusChannelId</code></li>
          <li><code>ticketTypes</code>, <code>ticketPanelChannelId</code></li>
          <li><code>applicationTypes</code>, <code>applicationPanelChannelId</code></li>
        </ul>
      </div>
    </div>

    <div class="card">
      <div class="section-header">
        <h3>3. Deploy Panels</h3>
      </div>
      <div class="stack">
        <button id="deploy-ticket">Deploy Ticket Panel</button>
        <button id="deploy-app" class="secondary">Deploy Application Panel</button>
      </div>
      <div id="deploy-status" class="small" style="margin-top:6px;"></div>
    </div>
  </div>

  <!-- Middle column: live board, tickets, apps -->
  <div>
    <div class="card">
      <div class="section-header">
        <h3>4. Live On-Duty Board</h3>
        <button id="refresh-duty" class="secondary">Refresh</button>
      </div>
      <div id="duty-live" class="list small">No guild selected.</div>
    </div>

    <div class="card">
      <div class="section-header">
        <h3>5. Tickets</h3>
        <button id="refresh-tickets" class="secondary">Refresh</button>
      </div>
      <div id="tickets" class="list small">No guild selected.</div>
    </div>

    <div class="card">
      <div class="section-header">
        <h3>6. Applications</h3>
        <button id="refresh-apps" class="secondary">Refresh</button>
      </div>
      <div id="apps" class="list small">No guild selected.</div>
    </div>
  </div>

  <!-- Right column: detail view -->
  <div>
    <div class="card">
      <h3>7. Detail</h3>
      <div id="detail-type" class="small" style="margin-bottom:4px;">Select a ticket or application.</div>
      <pre id="detail-json">{ }</pre>
    </div>
  </div>
</div>

<script>
  const guildSelect = document.getElementById('guild-select');
  const userInfo = document.getElementById('user-info');
  const configJson = document.getElementById('config-json');
  const dutyLiveDiv = document.getElementById('duty-live');
  const ticketsDiv = document.getElementById('tickets');
  const appsDiv = document.getElementById('apps');
  const deployStatus = document.getElementById('deploy-status');
  const detailType = document.getElementById('detail-type');
  const detailJson = document.getElementById('detail-json');

  let me = null;
  let currentGuildId = null;

  async function api(path, options = {}) {
    const res = await fetch(path, {
      headers: { 'Content-Type': 'application/json' },
      credentials: 'include',
      ...options
    });
    if (!res.ok) throw new Error(`${res.status} ${res.statusText}`);
    return res.json();
  }

  async function loadMe() {
    try {
      me = await api('/api/me');
      userInfo.textContent = `${me.username} (${me.id})`;
    } catch (err) {
      userInfo.textContent = 'Not authenticated. Redirecting...';
      setTimeout(() => {
        window.location.href = '/auth/discord';
      }, 800);
    }
  }

  async function loadGuilds() {
    const guilds = await api('/api/guilds');
    guildSelect.innerHTML = '';
    const optDefault = document.createElement('option');
    optDefault.value = '';
    optDefault.textContent = '-- Select guild --';
    guildSelect.appendChild(optDefault);
    guilds.forEach(g => {
      const opt = document.createElement('option');
      opt.value = g.id;
      opt.textContent = `${g.name} (${g.id})`;
      guildSelect.appendChild(opt);
    });
  }

  async function loadGuildConfig() {
    if (!currentGuildId) {
      configJson.value = '';
      return;
    }
    const cfg = await api(`/api/guilds/${currentGuildId}/config`);
    configJson.value = JSON.stringify(cfg, null, 2);
  }

  async function saveGuildConfig() {
    if (!currentGuildId) return;
    try {
      const payload = JSON.parse(configJson.value);
      const updated = await api(`/api/guilds/${currentGuildId}/config`, {
        method: 'POST',
        body: JSON.stringify(payload)
      });
      alert('Saved config.');
      configJson.value = JSON.stringify(updated, null, 2);
    } catch (err) {
      alert('Error saving config: ' + err.message);
    }
  }

  function fmtTime(ms) {
    const d = new Date(ms);
    return d.toLocaleString();
  }

  function humanDuration(ms) {
    const sec = Math.floor(ms / 1000);
    const h = Math.floor(sec / 3600);
    const m = Math.floor((sec % 3600) / 60);
    if (!h && !m) return '0m';
    const parts = [];
    if (h) parts.push(h + 'h');
    if (m) parts.push(m + 'm');
    return parts.join(' ');
  }

  async function loadDutyLive() {
    if (!currentGuildId) {
      dutyLiveDiv.textContent = 'No guild selected.';
      return;
    }
    const sessions = await api(`/api/guilds/${currentGuildId}/duty/live`);
    if (!sessions.length) {
      dutyLiveDiv.textContent = 'No one is currently on duty.';
      return;
    }
    dutyLiveDiv.innerHTML = '';
    sessions.forEach(s => {
      const row = document.createElement('div');
      row.className = 'row';
      const since = new Date(s.clockIn).toLocaleTimeString();
      const elapsed = humanDuration(Date.now() - s.clockIn);
      row.innerHTML = `
        <div><strong>${s.userId}</strong> – ${s.clockTypes.join(', ')}</div>
        <div class="small">Since: ${since} • Elapsed: ${elapsed}</div>
      `;
      dutyLiveDiv.appendChild(row);
    });
  }

  async function loadTickets() {
    if (!currentGuildId) {
      ticketsDiv.textContent = 'No guild selected.';
      return;
    }
    const tickets = await api(`/api/guilds/${currentGuildId}/tickets?status=open`);
    if (!tickets.length) {
      ticketsDiv.textContent = 'No open tickets.';
      return;
    }
    ticketsDiv.innerHTML = '';
    tickets.forEach(t => {
      const row = document.createElement('div');
      row.className = 'row';
      row.innerHTML = `
        <div>
          <span class="pill open">OPEN</span>
          <strong>${t.id}</strong> – ${t.type}
        </div>
        <div class="small">
          User: ${t.userId} • Channel: ${t.channelId} • Created: ${fmtTime(t.createdAt)}
        </div>
        <div class="small">
          <button data-ticket-id="${t.id}" class="secondary">View</button>
        </div>
      `;
      ticketsDiv.appendChild(row);
    });

    ticketsDiv.querySelectorAll('button[data-ticket-id]').forEach(btn => {
      btn.addEventListener('click', () => {
        const id = btn.getAttribute('data-ticket-id');
        showTicketDetail(id);
      });
    });
  }

  async function loadApps() {
    if (!currentGuildId) {
      appsDiv.textContent = 'No guild selected.';
      return;
    }
    const apps = await api(`/api/guilds/${currentGuildId}/applications?status=pending`);
    if (!apps.length) {
      appsDiv.textContent = 'No pending applications.';
      return;
    }
    appsDiv.innerHTML = '';
    apps.forEach(a => {
      const row = document.createElement('div');
      row.className = 'row';
      const id = a.id;
      row.innerHTML = `
        <div>
          <span class="pill pending">PENDING</span>
          <strong>${id}</strong> – ${a.type}
        </div>
        <div class="small">
          User: ${a.userId} • Created: ${fmtTime(a.createdAt)}
        </div>
        <div class="small">
          <button data-app-id="${id}" data-action="view" class="secondary">View</button>
          <button data-app-id="${id}" data-action="approve">Approve</button>
          <button data-app-id="${id}" data-action="deny" class="danger">Deny</button>
        </div>
      `;
      appsDiv.appendChild(row);
    });

    appsDiv.querySelectorAll('button[data-app-id]').forEach(btn => {
      btn.addEventListener('click', async () => {
        const id = btn.getAttribute('data-app-id');
        const action = btn.getAttribute('data-action');

        if (action === 'view') {
          showAppDetail(id);
          return;
        }

        let body = { status: action === 'approve' ? 'approved' : 'denied' };
        if (action === 'deny') {
          const reason = prompt('Reason for denial?') || 'No reason provided';
          body.reason = reason;
        }
        try {
          await api(`/api/guilds/${currentGuildId}/applications/${id}/decision`, {
            method: 'POST',
            body: JSON.stringify(body)
          });
          alert(`Application ${id} ${body.status}.`);
          loadApps();
        } catch (err) {
          alert('Error: ' + err.message);
        }
      });
    });
  }

  async function showTicketDetail(id) {
    if (!currentGuildId) return;
    try {
      const t = await api(`/api/guilds/${currentGuildId}/tickets/${id}`);
      detailType.textContent = `Ticket ${id}`;
      detailJson.textContent = JSON.stringify(t, null, 2);
    } catch (err) {
      alert('Error loading ticket: ' + err.message);
    }
  }

  async function showAppDetail(id) {
    if (!currentGuildId) return;
    try {
      const a = await api(`/api/guilds/${currentGuildId}/applications/${id}`);
      detailType.textContent = `Application ${id}`;
      detailJson.textContent = JSON.stringify(a, null, 2);
    } catch (err) {
      alert('Error loading application: ' + err.message);
    }
  }

  async function deployPanel(kind) {
    if (!currentGuildId) {
      alert('Select a guild first.');
      return;
    }
    deployStatus.textContent = `Deploying ${kind} panel...`;
    try {
      const result = await api(`/api/guilds/${currentGuildId}/deploy-panel`, {
        method: 'POST',
        body: JSON.stringify({ kind })
      });
      deployStatus.textContent = `✅ Deployed ${kind} panel. Message ID: ${result.messageId}`;
    } catch (err) {
      deployStatus.textContent = `❌ Error deploying ${kind} panel: ${err.message}`;
    }
  }

  guildSelect.addEventListener('change', async () => {
    currentGuildId = guildSelect.value || null;
    detailType.textContent = 'Select a ticket or application.';
    detailJson.textContent = '{ }';

    if (!currentGuildId) {
      configJson.value = '';
      dutyLiveDiv.textContent = 'No guild selected.';
      ticketsDiv.textContent = 'No guild selected.';
      appsDiv.textContent = 'No guild selected.';
      deployStatus.textContent = '';
      return;
    }
    await loadGuildConfig();
    await loadDutyLive();
    await loadTickets();
    await loadApps();
  });

  document.getElementById('reload-guild').addEventListener('click', async () => {
    if (!currentGuildId) return;
    await loadGuildConfig();
  });

  document.getElementById('save-config').addEventListener('click', saveGuildConfig);
  document.getElementById('refresh-duty').addEventListener('click', loadDutyLive);
  document.getElementById('refresh-tickets').addEventListener('click', loadTickets);
  document.getElementById('refresh-apps').addEventListener('click', loadApps);

  document.getElementById('deploy-ticket').addEventListener('click', () => deployPanel('ticket'));
  document.getElementById('deploy-app').addEventListener('click', () => deployPanel('application'));

  (async function init() {
    await loadMe();
    await loadGuilds();
  })();
</script>
</body>
</html>
